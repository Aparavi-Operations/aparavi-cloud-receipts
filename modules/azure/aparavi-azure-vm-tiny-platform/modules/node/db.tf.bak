resource "azurerm_mysql_firewall_rule" "db-access" {
  name                = "${var.name}-db-access"
  resource_group_name = var.resource_group_name
  server_name         = azurerm_mysql_server.db.name
  start_ip_address    = azurerm_public_ip.node.ip_address
  end_ip_address      = azurerm_public_ip.node.ip_address
}
resource "azurerm_mysql_firewall_rule" "db-access-ext" {
  for_each            = toset(var.db_access_ips)
  name                = "${var.name}-db-access-${each.key}"
  resource_group_name = var.resource_group_name
  server_name         = azurerm_mysql_server.db.name
  start_ip_address    = "${each.value}"
  end_ip_address      = "${each.value}"
}
resource "azurerm_mysql_server" "db" {
  public_network_access_enabled    = true
  ssl_enforcement_enabled          = false
  ssl_minimal_tls_version_enforced = "TLSEnforcementDisabled"


  sku_name   = var.db_shape
  storage_mb = var.db_size
  version    = "8.0"

  auto_grow_enabled                 = true
  geo_redundant_backup_enabled      = true
  infrastructure_encryption_enabled = true

}
resource "azurerm_private_dns_zone" "example" {
  name                = "example.mysql.database.azure.com"
  resource_group_name = azurerm_resource_group.example.name
}

resource "azurerm_private_dns_zone_virtual_network_link" "example" {
  name                  = "exampleVnetZone.com"
  private_dns_zone_name = azurerm_private_dns_zone.example.name
  virtual_network_id    = azurerm_virtual_network.example.id
  resource_group_name   = azurerm_resource_group.example.name
}

resource "azurerm_mysql_flexible_server" "example" {
  name                             = "${var.name}-aparavi"
  location                         = var.resource_group_location
  resource_group_name              = var.resource_group_name
  administrator_login          = var.db_username
  administrator_password = var.db_password
  create_mode                      = "Default"
  backup_retention_days  = 7
  delegated_subnet_id    = azurerm_subnet.example.id
  private_dns_zone_id    = azurerm_private_dns_zone.example.id
  sku_name               = var.db_shape

  depends_on = [azurerm_private_dns_zone_virtual_network_link.example]
  tags = merge(var.tags, {
    Name         = var.name
    component    = var.component
    subcomponent = "rds"
  })
}
